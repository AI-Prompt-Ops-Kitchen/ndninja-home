#!/usr/bin/env bash
# Rasengan pre-push hook â€” emits git.push events (fire-and-forget)
# Install: cp to .git/hooks/pre-push && chmod +x
# Git passes: remote_name remote_url as args, commit range on stdin

RASENGAN_URL="${RASENGAN_URL:-http://127.0.0.1:8050}"

remote_name="${1:-origin}"
remote_url="${2:-unknown}"
branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

local_sha=""
remote_sha=""
commit_count=0

# Read push info from stdin (format: <local ref> <local sha> <remote ref> <remote sha>)
while read -r local_ref local_s remote_ref remote_s; do
  local_sha="${local_s}"
  remote_sha="${remote_s}"
  # Count commits being pushed
  if [ "${remote_s}" = "0000000000000000000000000000000000000000" ]; then
    commit_count=$(git rev-list --count "${local_s}" 2>/dev/null || echo 0)
  else
    commit_count=$(git rev-list --count "${remote_s}..${local_s}" 2>/dev/null || echo 0)
  fi
done

payload=$(cat <<EOF
{
  "event_type": "git.push",
  "source": "git-hook",
  "payload": {
    "branch": "${branch}",
    "remote": "${remote_name}",
    "remote_url": "${remote_url}",
    "local_sha": "${local_sha}",
    "remote_sha": "${remote_sha}",
    "commit_count": ${commit_count:-0}
  }
}
EOF
)

curl -s -X POST "${RASENGAN_URL}/events" \
  -H "Content-Type: application/json" \
  -d "$payload" \
  --connect-timeout 2 --max-time 2 \
  >/dev/null 2>&1 &

exit 0
